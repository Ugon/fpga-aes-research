\section{System implementation}
To compare performance of proposed AES circuit designs they were implemented in VHDL hardware description language and deployed on Terasic DE1-SoC development board. This chapter summarizes relevant to this research details of FPGA technology, describes implementation details of proposed AES designs and provides test results.
   
\subsection{Chosen hardware platform}
Terasic DE1-SoC deveopment board.

\subsection{Low level FPGA chip analysis}
\label{sec:low-level-fpga}
To optimize a circuit for high frequency operation it is necessary to understand how FPGA technology works on low level. FPGA chips' architectures may slightly vary, here focus is placed on architecture of the chip that was used for testing - Altera Cyclone V \cite[Chapter 1]{altera-vol1}. For simplicity only elements relevant to this research will be covered, detailed documentation is available in Cyclone V Handbook \cite{altera-vol1}.

FPGA chips consist of LABs (Logic Array Blocks), each of which contains 10 ALMs (Adaptive Logic Modules). ALMs are elements that make it possible to place arbitrary circuits in FPGA - they can be programmed to implement combinatorial logic functions, arithmetic functions, and registers.

Combinatorial logic is implemented in ALMS using LUTs (look-up tables) which contain high speed memory. This memory is programmed with precomputed outputs for every possible combination of logic levels of input signals. LUTs take combinatorial logic inputs and use them as addresses to corresponding memory bits. Output of LUT is a bit read from memory which corresponds to provided inputs. An important consequence of this design feature is that for a LUT with N inputs it is irrelevant how complex the logic to be implemented is - as long as it has no more than N inputs it will always perform the same. This is because all outputs are precomputed and all it takes to determine the output is to read it from memory. If desired combinatorial logic has more than N inputs multiple LUTs will be required.

In Cyclone V chips each ALM contains two LUTs and four registers (D flip-flops). The registers, however, are wired in such a way that only two are relevant for this design - other two could be utilised if ALMs were used to implement arithmetic logic, which does not happen in AES encryption. LUTs in Cyclone V ALMs are capable of implementing different combinations of combinatorial logic, for this design the relevant combinations are:
\begin{itemize}[noitemsep]
\item one 6-input LUT per ALM - uses up to 1 register, leaves at least one register unused
\item two 4-input LUTs per ALM - uses up to 2 registers
\end{itemize}

Combinatorial logic outputs can either be registered in the ALM they were calculated in or routed to another ALM without registering. For fastest operation in most cases it is desired to register them in the same ALM, because routing inside ALM is a lot faster than between ALMs. Routing outputs without registering is necessary when combinatorial logic has more inputs than a single ALM supports, or to move the register closer to other parts of the design to balance routing delays.

% Conducted tests showed that for AES encryption maximum frequency was higher for designs using only 4-input LUTs. Analysis of compilation reports showed that using 6-input LUTs resulted in overall increased number or resources used, which resulted in longer routing paths between parts of the design, which ultimately slowed it down. This makes sence, because for 4-input LUTs ALMs are used more efficiently - more combinatorial logic could be implemented, and both registers could be used. The leftover register when using 6-input operation mode was observed not to be used often, because other signals were typically registered in same ALMs they were calculated in.
Conducted tests showed that for AES encryption maximum frequency was higher for designs using only 4-input LUTs. Analysis of compilation reports showed that using 6-input LUTs resulted in paths with longer signal propagation time, which slowed the design down. This makes sense, because for 4-input LUTs ALMs are used more efficiently - more combinatorial logic could be implemented, and both registers could be used. The leftover register when using 6-input operation mode was observed not to be used often, because other signals were typically registered in same ALMs they were calculated in.

% Another important aspect of working with FPGA is that \textit{Place and Route} compilation phase, which is responsible of finding optimal placement of the design in FPGA chip, tackles an NP-hard problem. This phase therefore uses heuristics to produce an approximation of best possible solution. It is possible that final placement of the design will be different for each compilation attempt. This behaviour was observed during testing, but maximum frequency for given design remained stable between compilation attempts. The longest routes for each compilation were different every time, but leading trends were similar (eg. most routes from top 10 failing ones were between pipelined stages X and Y).


\subsection{VHDL description of the system's general structure}
np. na poziomie Entity, żeby pokazać w jakim języku była realizowana implementacja i jakie są interfejsy

\subsection{Implementation details of proposed designs}


\subsubsection{Pipelined unrolled architecture with stages of equal critical path length}

This design proposal was implemented as part of this research as proposed in \cite{vlsi}.

Testing of the design showed that all transformations individually could run at frequencies exceeding 500MHz (close to or at testing circuits max frequency of 530MHz). One full round could run at this frequency as well, but adding more consecutive rounds resulted in decrease of frequency due to FPGA resource congestion resulting in longer routing paths. Full AES encryption circuit, which consists of 15 rounds, was capable of operating at \textbf{375MHz} and consumed \textbf{15123} ALM resources.

Analysis of paths with longest propagation time presented in compilation report showed that typically they consisted of two or more ALMs used for calculating combinatorial logic. This was due to the fact that this design used pipelining stages which for calculating each output bit required more than 6 inputs. This forced utilising multiple ALMs between registers, which resulted in long routing delays.

The conclusions of this research were:
\begin{itemize}[noitemsep]
\item To achieve higher frequency it was necessary to split the design into shorter pipelining stages.
\item Critical path length calculated as number of layers of logical gates is irrelevant (sec. \ref{sec:low-level-fpga}).
\item What is relevant is the number of input signals required for calculating each bit of stage output, which should be no higher than 6.
\item Routing delays are a significant factor contributing to maximum achievable frequency.
\item Reducing number of LUTs between registers is critical for high performance.
\end{itemize}

\subsubsection{Pipelined unrolled architecture with stages containing one ALM}
\label{sec:implementation-pipe-unrolled-one-alm}

First approach to implementing this circuit was to split pipelining stages so that they used 4-input as well as 6-input LUTs. This approach resulted in increased performance, but analysis of compilation reports showed that paths with longest signal propagation time typically led through ALMs utilising 6-input operation mode. The circuit was therefore further redesigned to take advantage of only 4-input operation mode. Final design was capable of operating at \textbf{406MHz}, which is the highest achieved frequency for AES encryption observed in this research. The number of logic elements as reported by compiler for this design was \textbf{22411} (excluding 806 elements required for testing circuit).

This section will describe in detail how each operation in AES algorithm can be split into stages taking advantage of only 4-input LUT operation mode. To utilise this mode each registered output bit needs to depend on no more than 4 inputs.

\input{sections/subsections/pipeline-details}


\subsubsection{Pipelined looped architecture with stages containing one ALM}

speed: 467MHz\\
LE: 2234\\
Figure \ref{fig:rolled-high-speed-pipe-full}


\begin{sidewaysfigure}[!h]
\centering
\includegraphics[scale=2]{rolled-high-speed-pipe-full}
\caption{Modified pipeline for pipelined rolled up architecture}
\label{fig:rolled-high-speed-pipe-full}
\end{sidewaysfigure}


\subsubsection{Pipelined rolled up architecture using on-chip memory}
